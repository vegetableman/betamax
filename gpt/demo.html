<!DOCTYPE html>
<html>
<head>
  <title>Pack Differences</title>
</head>
<body>
  <input type="file" id="fileInput1" />
  <input type="file" id="fileInput2" />
  <button id="compareButton" disabled>Compare Images</button>
  <button id="packButton" disabled>Pack Differences</button>
  <canvas id="resultCanvas"></canvas>

  <script>
    const fileInput1 = document.getElementById("fileInput1");
    const fileInput2 = document.getElementById("fileInput2");
    const compareButton = document.getElementById("compareButton");
    const packButton = document.getElementById("packButton");
    const resultCanvas = document.getElementById("resultCanvas");
    let image1Data, image2Data;
    let currentFileIndex = 0;
    let worker;

    fileInput1.addEventListener("change", handleFileSelect);
    fileInput2.addEventListener("change", handleFileSelect);

    function handleFileSelect(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          if (currentFileIndex === 0) {
            image1Data = getImageData(img);
            currentFileIndex++;
          } else if (currentFileIndex === 1) {
            image2Data = getImageData(img);
            compareButton.disabled = false;
            compareButton.addEventListener("click", compareImages);
            currentFileIndex = 0; // Reset the file index for future comparisons
          }
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }

    function getImageData(img) {
      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      context.drawImage(img, 0, 0);
      return context.getImageData(0, 0, canvas.width, canvas.height);
    }

    compareButton.addEventListener("click", compareImages);

    let diffData, width, height;
    function compareImages() {
      worker = new Worker("worker.js");
      worker.postMessage({ image1Data, image2Data });
      worker.onmessage = function(event) {
        const message = event.data;
        if (message.compareReady) {
          packButton.disabled = false;
          diffData = message.diffData;
          width = message.width;
          height = message.height;
          {{/*  resultCanvas.getContext("2d").putImageData(new ImageData(diffData, width, height), 0, 0);  */}}
        } else if (message.packReady) {
          /*const packedImageData = message.packedImageData;
          createImageBitmap(packedImageData).then(function(imageBitmap) {
            resultCanvas.getContext("2d").drawImage(imageBitmap, 0, 0);
            //saveButton.disabled = false;
          });*/

          const packedImageData = message.packedImageData;
          resultCanvas.width = packedImageData.width;
          resultCanvas.height = packedImageData.height;
          resultCanvas.getContext("2d").putImageData(packedImageData, 0, 0);
        }
      };
    }

    packButton.addEventListener("click", packDifferences);

    function packDifferences() {
      worker.postMessage({ pack: true, diffData, width, height });
    }
  </script>

  <script src="worker.js"></script>
</body>
</html>
