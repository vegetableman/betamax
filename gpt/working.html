<!DOCTYPE html>
<html>
<head>
  <title>Image Difference</title>
  <style>
    canvas {
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <h1>Image Difference</h1>
  <input type="file" id="image1" accept="image/*">
  <input type="file" id="image2" accept="image/*">
  <br>
  <canvas id="canvas"></canvas>
  <br>
  <button id="compareBtn">Compare Images</button>
  <br>
  <button id="packBtn" disabled>Pack Differences</button>
  <br>
  <button id="saveBtn" disabled>Save Packed Image</button>

  <script>
    function handleImageUpload(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (readerEvent) {
        const img = new Image();
        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          const context = canvas.getContext("2d");
          context.drawImage(img, 0, 0);
        };
        img.src = readerEvent.target.result;
      };

      reader.readAsDataURL(file);
    }

    function compareImages() {
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");

      const image1 = document.getElementById("image1").files[0];
      const image2 = document.getElementById("image2").files[0];

      if (image1 && image2) {
        const reader1 = new FileReader();
        const reader2 = new FileReader();

        reader1.onload = function (reader1Event) {
          const img1 = new Image();
          img1.onload = function () {
            canvas.width = img1.width;
            canvas.height = img1.height;
            context.drawImage(img1, 0, 0);

            reader2.onload = function (reader2Event) {
              const img2 = new Image();
              img2.onload = function () {
                const diffCanvas = document.createElement("canvas");
                diffCanvas.width = img1.width;
                diffCanvas.height = img1.height;
                const diffContext = diffCanvas.getContext("2d");
                diffContext.drawImage(img2, 0, 0);
                const imgData1 = context.getImageData(0, 0, img1.width, img1.height);
                const imgData2 = diffContext.getImageData(0, 0, img1.width, img1.height);
                const diffData = context.createImageData(img1.width, img1.height);

                for (let i = 0; i < imgData1.data.length; i += 4) {
                  const r1 = imgData1.data[i];
                  const g1 = imgData1.data[i + 1];
                  const b1 = imgData1.data[i + 2];
                  const r2 = imgData2.data[i];
                  const g2 = imgData2.data[i + 1];
                  const b2 = imgData2.data[i + 2];

                  if (r1 !== r2 || g1 !== g2 || b1 !== b2) {
                    diffData.data[i] = r2;
                    diffData.data[i + 1] = g2;
                    diffData.data[i + 2] = b2;
                    diffData.data[i + 3] = 255; // Alpha value
                  } else {
                    diffData.data[i + 3] = 0; // Transparent pixel for non-differences
                  }
                }

                diffContext.putImageData(diffData, 0, 0);

                const packBtn = document.getElementById("packBtn");
                packBtn.disabled = false;
                packBtn.onclick = function () {
                  const packedCanvas = packDifferences(diffData, img1.width, img1.height);
                  const packedDataURL = packedCanvas.toDataURL("image/png");

                  const saveBtn = document.getElementById("saveBtn");
                  saveBtn.disabled = false;
                  saveBtn.onclick = function () {
                    const a = document.createElement("a");
                    a.href = packedDataURL;
                    a.download = "packed_differences.png";
                    a.click();
                  };
                };
              };
              img2.src = reader2Event.target.result;
            };

            reader2.readAsDataURL(image2);
          };
          img1.src = reader1Event.target.result;
        };

        reader1.readAsDataURL(image1);
      }
    }

    function packDifferences(diffData, width, height) {
      const packedCanvas = document.createElement("canvas");
      packedCanvas.width = width;
      packedCanvas.height = height;
      const packedContext = packedCanvas.getContext("2d");

      for (let i = 0; i < diffData.data.length; i += 4) {
        const x = (i / 4) % width;
        const y = Math.floor((i / 4) / width);

        const alpha = diffData.data[i + 3];

        if (alpha > 0) {
          const r = diffData.data[i];
          const g = diffData.data[i + 1];
          const b = diffData.data[i + 2];

          packedContext.fillStyle = `rgb(${r}, ${g}, ${b})`;
          packedContext.fillRect(x, y, 1, 1);
        }
      }

      return packedCanvas;
    }

    const image1Input = document.getElementById("image1");
    const image2Input = document.getElementById("image2");
    image1Input.addEventListener("change", handleImageUpload);
    image2Input.addEventListener("change", handleImageUpload);

    const compareBtn = document.getElementById("compareBtn");
    compareBtn.addEventListener("click", compareImages);
  </script>
</body>
</html>
